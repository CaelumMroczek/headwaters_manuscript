group_by(scenario, period) %>%
summarise(mean_AF_cluster_bal = mean(mean_AF_cluster, na.rm = TRUE), .groups = "drop") %>%
mutate(period = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)")))
readr::write_csv(af_period_bal, here("5-out/af_period_totals_clusterbalanced.csv"))
p_net <- ggplot(af_period_bal,
aes(x = period, y = mean_AF_cluster_bal/1e6, fill = scenario)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_col(position = position_dodge(width = 0.6), width = 0.55) +
scale_fill_manual(values = c(SSP245 = "#2487EE", SSP585 = "#ff3432")) +
labs(x = "Period", y = "Net AF change (million AF/yr)",
title = "Projected net base-flow change (cluster-balanced)") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(), legend.position = "top")
p_net
ggsave(here("5-out/figures/annual_anomaly_vol.svg"), p_net, width = 9, height = 6, dpi = 600)
ggsave(here("5-out/figures/annual_anomaly_vol.png"), p_net, width = 9, height = 6, dpi = 600)
# Annual AF change per basin (already computed as annual_af)
# Basin-level linear slope (AF/year) → AF/decade
basin_trends <- annual_af %>%
group_by(scenario, cluster, basin_id) %>%
do({
df <- .
if (n_distinct(df$year) < 5 || all(is.na(df$af_change))) {
tibble(slope_decade = NA_real_)
} else {
fit <- tryCatch(lm(af_change ~ year, data = df), error = function(e) NULL)
if (is.null(fit)) tibble(slope_decade = NA_real_) else {
s <- coef(fit)[["year"]]
tibble(slope_decade = as.numeric(s) * 10)  # AF per decade
}
}
}) %>%
ungroup()
decadal_cluster <- basin_trends %>%
group_by(scenario, cluster) %>%
summarise(
med_decadal_AF = median(slope_decade, na.rm = TRUE),
p25            = quantile(slope_decade, 0.25, na.rm = TRUE),
p75            = quantile(slope_decade, 0.75, na.rm = TRUE),
n_basins       = sum(!is.na(slope_decade)),
.groups = "drop"
) %>%
mutate(
cluster = factor(cluster, levels = c(1,2,3,4)),
med_MAF_decade = med_decadal_AF / 1e6,
p25_MAF = p25 / 1e6,
p75_MAF = p75 / 1e6
) %>%
arrange(cluster, scenario)
readr::write_csv(decadal_cluster, here("5-out/decadal_volume_trends_by_cluster.csv"))
# Plot -----
p_decadal <- ggplot(decadal_cluster,
aes(x = cluster, y = med_MAF_decade, fill = scenario)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_col(position = position_dodge(width = 0.6), width = 0.5) +
geom_errorbar(aes(ymin = p25_MAF, ymax = p75_MAF),
position = position_dodge(width = 0.6), width = 0.15, linewidth = 0.6) +
scale_fill_manual(values = c(SSP245 = "#2487EE", SSP585 = "#ff3432")) +
labs(
x = "Cluster",
y = "Decadal base-flow trend (million AF / decade)",
title = "Median decadal volumetric base-flow trends by cluster and scenario",
subtitle = "Bars = cluster medians; error bars = IQR across basins"
) +
theme_minimal(base_size = 12) +
theme(#panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, linewidth = 0.5),
legend.position  = "top")
p_decadal
ggsave(here("5-out/figures/decadal_AF_trend_by_cluster.svg"), p_decadal, width = 8.5, height = 5.5, dpi = 600)
ggsave(here("5-out/figures/decadal_AF_trend_by_cluster.png"), p_decadal, width = 8.5, height = 5.5, dpi = 600)
# Monthly cfs anomaly → monthly AF anomaly
anoms_af <- preds_all_full %>%
mutate(af_month = cf_to_af(anomaly_abs, year, month))
# ---- Cluster-balanced means + IQR(25–75%) across clusters ----
af_cluster_means <- annual_af %>%
group_by(scenario, period, cluster) %>%
summarise(mean_AF_cluster = mean(af_change, na.rm = TRUE), .groups = "drop")
af_period_bal <- af_cluster_means %>%
group_by(scenario, period) %>%
summarise(
mean_AF_cluster_bal = mean(mean_AF_cluster, na.rm = TRUE),
q25 = quantile(mean_AF_cluster, 0.25, na.rm = TRUE),
q75 = quantile(mean_AF_cluster, 0.75, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
period = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)")),
mean_mAFyr = mean_AF_cluster_bal / 1e6,
ymin_mAFyr = q25 / 1e6,
ymax_mAFyr = q75 / 1e6
)
pd <- position_dodge(width = 0.6)
p_net <- ggplot(af_period_bal,
aes(x = period, y = mean_mAFyr, fill = scenario)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_col(position = pd, width = 0.55) +
geom_errorbar(aes(ymin = ymin_mAFyr, ymax = ymax_mAFyr),
position = pd, width = 0.18, linewidth = 0.5) +
scale_fill_manual(values = c(SSP245 = "#2487EE", SSP585 = "#ff3432")) +
labs(x = "Period", y = "Net AF change (million AF/yr)",
title = "Projected net base-flow change (cluster-balanced)",
caption = "Bars = mean of cluster means; error bars = 25–75th percentile across clusters") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(), legend.position = "top")
p_net
View(af_period_bal)
View(af_cluster_means)
# compute cluster means (same as before)
af_cluster_means <- annual_af %>%
group_by(scenario, period, cluster) %>%
summarise(mean_AF_cluster = mean(af_change, na.rm = TRUE), .groups = "drop") %>%
mutate(period = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)")),
mean_mAFyr = mean_AF_cluster/1e6)
# cluster-balanced bar heights
af_period_bal <- af_cluster_means %>%
group_by(scenario, period) %>%
summarise(mean_mAFyr = mean(mean_mAF_cluster/1e6, na.rm = TRUE), .groups = "drop")
# Monthly cfs anomaly → monthly AF anomaly
anoms_af <- preds_all_full %>%
mutate(af_month = cf_to_af(anomaly_abs, year, month))
# Annual AF change per basin
annual_af <- anoms_af %>%
group_by(scenario, basin_id, cluster, year) %>%
summarise(af_change = sum(af_month, na.rm = TRUE), .groups = "drop") %>%
mutate(period = tag_period(year)) %>%
filter(!is.na(period))
# Cluster-balanced: average within cluster, then average across clusters
af_period_bal <- annual_af %>%
group_by(scenario, period, cluster) %>%
summarise(mean_AF_cluster = mean(af_change, na.rm = TRUE), .groups = "drop") %>%
group_by(scenario, period) %>%
summarise(mean_AF_cluster_bal = mean(mean_AF_cluster, na.rm = TRUE), .groups = "drop") %>%
mutate(period = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)")))
readr::write_csv(af_period_bal, here("5-out/af_period_totals_clusterbalanced.csv"))
p_net <- ggplot(af_period_bal,
aes(x = period, y = mean_AF_cluster_bal/1e6, fill = scenario)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_col(position = position_dodge(width = 0.6), width = 0.55) +
scale_fill_manual(values = c(SSP245 = "#2487EE", SSP585 = "#ff3432")) +
labs(x = "Period", y = "Net AF change (million AF/yr)",
title = "Projected net base-flow change (cluster-balanced)") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(), legend.position = "top")
p_net
ggsave(here("5-out/figures/annual_anomaly_vol.svg"), p_net, width = 9, height = 6, dpi = 600)
ggsave(here("5-out/figures/annual_anomaly_vol.png"), p_net, width = 9, height = 6, dpi = 600)
library(dplyr)
library(tidyr)
library(ggplot2)
library(glue)
library(readr)
library(here)
library(purrr)
library(stringr)
library(lubridate)
library(scales)
# ---------- Data ----------
# Projections (contain yhat_log and predictors)
preds_245 <- read_csv(here("5-out/predictions_ssp245_full_2025-2099.csv"))
preds_585 <- read_csv(here("5-out/predictions_ssp585_full_2025-2099.csv"))
# Evaluation (model predictions for 2014–2024 as log_baseflow)
eval_245 <- read_csv(here("1-data/WUS-D3_climate_data/eval_data_ssp245.csv"))
eval_585 <- read_csv(here("1-data/WUS-D3_climate_data/eval_data_ssp585.csv"))
# Training (for baseline)
training_data <- read_csv(here("1-data/training_data.csv")) %>%
mutate(log_baseflow = log(pmax(baseflow, 0.001)))
# ---------- Helpers ----------
tag_period <- function(y) dplyr::case_when(
y >= 2025 & y <= 2049 ~ "Early (2025–2049)",
y >= 2050 & y <= 2074 ~ "Mid (2050–2074)",
y >= 2075 & y <= 2099 ~ "Late (2075–2099)",
TRUE ~ NA_character_
)
# Smearing factors (by cluster)
smear_tbl <- tibble::tibble(
cluster = factor(c(1, 2, 3, 4)),
smear   = c(1.03, 1.03, 0.957, 0.764)
)
ensure_linear_preds <- function(df, smear_tbl) {
if (!"baseflow_hat" %in% names(df)) {
df <- df %>%
mutate(cluster = factor(cluster),
month   = as.integer(month)) %>%
left_join(smear_tbl, by = "cluster") %>%
mutate(
smear        = coalesce(smear, 1.0),
yhat_log     = if ("yhat_log" %in% names(.)) yhat_log else log_baseflow,
baseflow_hat = exp(yhat_log) * smear
) %>%
select(-smear)
}
df
}
# cfs -> AF for a given month
cf_to_af <- function(cfs, y, m) {
d <- lubridate::days_in_month(lubridate::ymd(paste(y, m, 15)))
(cfs * 86400 * d) / 43560
}
# ---------- Baseline (historical, observed) ----------
# Monthly baseline in cfs; convert to AF when needed with cf_to_af()
baseline <- training_data %>%
filter(year >= 1980, year <= 2013) %>%
group_by(cluster, month) %>%
summarise(baseline_bf = mean(baseflow, na.rm = TRUE), .groups = "drop") %>%
mutate(cluster = as.factor(cluster), month = as.integer(month))
# ---------- Prepare projections ----------
preds_245 <- preds_245 %>% mutate(cluster = as.factor(cluster), month = as.integer(month))
preds_585 <- preds_585 %>% mutate(cluster = as.factor(cluster), month = as.integer(month))
preds_245_full <- ensure_linear_preds(preds_245, smear_tbl) %>% mutate(scenario = "SSP245")
preds_585_full <- ensure_linear_preds(preds_585, smear_tbl) %>% mutate(scenario = "SSP585")
preds_all_full <- bind_rows(preds_245_full, preds_585_full) %>%
left_join(baseline, by = c("cluster","month"))
# ---------- Build monthly AF + %AF anomalies ----------
preds_vol <- preds_all_full %>%
mutate(
pred_AF      = cf_to_af(baseflow_hat, year, month),
baseline_AF  = cf_to_af(baseline_bf,  year, month),
anomaly_AF   = pred_AF - baseline_AF,
anomaly_AFpc = 100 * anomaly_AF / baseline_AF
)
# Colors
clrs <- c(`1`="#7db030", `2`="#ff3432", `3`="#FFB81F", `4`="#2487EE")
# Cluster-balanced aggregation (equal weight across clusters)
annual_proj_cluster <- preds_all_full %>%
filter(year >= 2025, year <= 2099) %>%
group_by(scenario, cluster, year) %>%
summarise(annual_pct = mean(anomaly_pct, na.rm = TRUE), .groups = "drop")
# Cluster-balanced aggregation (equal weight across clusters)
annual_proj_cluster <- preds_all_full %>%
filter(year >= 2025, year <= 2099) %>%
group_by(scenario, cluster, year) %>%
summarise(annual_pct = mean(anomaly_AFpc, na.rm = TRUE), .groups = "drop")
# Cluster-balanced aggregation (equal weight across clusters)
annual_proj_cluster <- preds_vol %>%
filter(year >= 2025, year <= 2099) %>%
group_by(scenario, cluster, year) %>%
summarise(annual_pct = mean(anomaly_AFpc, na.rm = TRUE), .groups = "drop")
annual_domain <- annual_proj_cluster %>%
group_by(scenario, year) %>%
summarise(
mean_val = mean(annual_pct, na.rm = TRUE),
lo       = quantile(annual_pct, 0.05, na.rm = TRUE),
hi       = quantile(annual_pct, 0.95, na.rm = TRUE),
.groups  = "drop"
)
annual_eval_cluster <- eval_preds_lin %>%
group_by(scenario, cluster, year) %>%
summarise(annual_pct = mean(anomaly_pct, na.rm = TRUE), .groups = "drop")
# --- PERIOD TAG ---
preds_vol <- preds_vol %>%
mutate(period = tag_period(year)) %>%
filter(!is.na(period))
# --- Annualize per basin, then summarize by cluster ---
annual_cluster <- preds_vol %>%
group_by(scenario, cluster, basin_id, period, year) %>%
summarise(
pred_AF_yr     = sum(pred_AF, na.rm = TRUE),
baseline_AF_yr = sum(baseline_AF, na.rm = TRUE),
anomaly_AF_yr  = sum(anomaly_AF, na.rm = TRUE),
.groups = "drop_last"
) %>%
mutate(
pct_change_yr = 100 * anomaly_AF_yr / baseline_AF_yr
) %>%
ungroup()
# Summary for plotting:
# - Volumetric = sum of annual anomalies across basins (cluster contribution in mAF/yr)
# - Percent    = median (robust) of basin annual % changes within cluster
scatter_summary <- annual_cluster %>%
group_by(scenario, cluster, period) %>%
summarise(
vol_change_mAF = sum(anomaly_AF_yr, na.rm = TRUE) / 1e6,
pct_change_med = median(pct_change_yr, na.rm = TRUE),
n_basins       = dplyr::n_distinct(basin_id),
.groups = "drop"
) %>%
mutate(
cluster = factor(cluster),
period  = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)"))
)
# --- Plot (Option 3) ---
pd_cols <- c(SSP245 = "#2487EE", SSP585 = "#ff3432")
shapes  <- c("Early (2025–2049)" = 21, "Mid (2050–2074)" = 22, "Late (2075–2099)" = 24)
p_pct_vol <- ggplot(scatter_summary,
aes(x = pct_change_med, y = vol_change_mAF,
fill = scenario, shape = period, label = cluster)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey60") +
geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") +
geom_point(size = 4.2, color = "black", stroke = 0.6) +
geom_text(vjust = -1.0, size = 3.6, fontface = "bold") +
scale_fill_manual(values = pd_cols, name = "Scenario") +
scale_shape_manual(values = shapes, name = "Period") +
labs(
x = "% change from baseline (annual, median across basins)",
y = "Volume change (million AF/yr, summed across basins in cluster)",
title = "Relative vs. absolute base-flow change by cluster",
subtitle = "Each point = cluster × scenario × period; labels are cluster IDs",
caption = "Percent = median basin-level annual % change; Volume = sum of basin-level annual AF anomalies.\nThis reveals clusters with modest % change but large absolute losses (e.g., Cluster 2)."
) +
theme_minimal(base_size = 12) +
theme(
legend.position = "top",
panel.grid.minor = element_blank()
)
p_pct_vol
preds_vol <- preds_all_full %>%
mutate(
pred_AF      = cf_to_af(baseflow_hat, year, month),     # predicted AF this month
baseline_AF  = cf_to_af(baseline_bf,  year, month),     # baseline AF using this month's days
anomaly_AF   = pred_AF - baseline_AF,                   # absolute AF change (monthly)
anomaly_AFpc = 100 * anomaly_AF / baseline_AF           # percent AF change (monthly)
)
preds_vol <- preds_all_full %>%
mutate(
pred_AF      = cf_to_af(baseflow_hat, year, month),     # predicted AF this month
baseline_AF  = cf_to_af(baseline_bf,  year, month),     # baseline AF using this month's days
anomaly_AF   = pred_AF - baseline_AF,                   # absolute AF change (monthly)
anomaly_AFpc = 100 * anomaly_AF / baseline_AF           # percent AF change (monthly)
)
# ---- Annualize by basin, then aggregate to cluster (median like your % plot) ----
annual_vol_basin <- preds_vol %>%
filter(year >= 2025, year <= 2099) %>%
group_by(scenario, cluster, basin_id, year) %>%
summarise(
pred_AF_year = sum(pred_AF, na.rm = TRUE),
base_AF_year = sum(baseline_AF, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
anomaly_AF_year   = pred_AF_year - base_AF_year,                        # AF/yr
anomaly_AFpc_year = dplyr::if_else(base_AF_year > 0,
100 * anomaly_AF_year / base_AF_year,
NA_real_)
)
annual_vol_cluster <- annual_vol_basin %>%
group_by(scenario, cluster, year) %>%
summarise(
annual_pct    = median(anomaly_AFpc_year, na.rm = TRUE),                # % anomaly
annual_AF_MAF = median(anomaly_AF_year,    na.rm = TRUE) / 1e6,         # MAF / yr
.groups = "drop"
) %>%
mutate(cluster = factor(cluster, levels = c("1","2","3","4")))
# ---- Colors (your cluster palette) ----
clrs <- c(`1`="#7db030", `2`="#ff3432", `3`="#FFB81F", `4`="#2487EE")
# ---- Plot 1: Annual % anomalies (volumetric) ----
p_annual_vol_pct <- ggplot(annual_vol_cluster,
aes(x = year, y = annual_pct, color = cluster)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_line(linewidth = 0.9, alpha = 0.95) +
facet_wrap(~ scenario, ncol = 1) +
scale_color_manual(values = clrs, name = "Cluster") +
scale_x_continuous(breaks = seq(2025, 2100, 5),
expand = expansion(mult = c(0.01, 0.01))) +
geom_vline(xintercept = c(2050, 2075), linetype = "dotted",
color = "grey40", linewidth = 0.6) +
labs(
title    = "Annual Baseflow Volume Percent Anomalies (2025–2099)",
subtitle = "Median annual volumetric anomaly by cluster and scenario",
x = "Year",
y = "Percent difference from 1980–2013 (%)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, linewidth = 0.5),
strip.background = element_rect(fill = "grey90", color = "black"),
legend.position  = "top")
p_annual_vol_pct
# ---- Plot 2 (optional but handy): Annual absolute anomalies (MAF/yr) ----
p_annual_vol_abs <- ggplot(annual_vol_cluster,
aes(x = year, y = annual_AF_MAF, color = cluster)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
geom_line(linewidth = 0.9, alpha = 0.95) +
facet_wrap(~ scenario, ncol = 1) +
scale_color_manual(values = clrs, name = "Cluster") +
scale_x_continuous(breaks = seq(2025, 2100, 5),
expand = expansion(mult = c(0.01, 0.01))) +
geom_vline(xintercept = c(2050, 2075), linetype = "dotted",
color = "grey40", linewidth = 0.6) +
labs(
title    = "Annual Baseflow Volume Anomalies (2025–2099)",
subtitle = "Median annual volumetric anomaly by cluster and scenario",
x = "Year",
y = "Anomaly (million AF / year)"
) +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
panel.border     = element_rect(color = "black", fill = NA, linewidth = 0.5),
strip.background = element_rect(fill = "grey90", color = "black"),
legend.position  = "top")
p_annual_vol_abs
p_annual_vol_pct
library(dplyr)
library(tidyr)
library(ggplot2)
library(glue)
library(readr)
library(here)
library(purrr)
library(stringr)
library(lubridate)
library(scales)
# ---------- Data ----------
# Projections (contain yhat_log and predictors)
preds_245 <- read_csv(here("5-out/predictions_ssp245_full_2025-2099.csv"))
preds_585 <- read_csv(here("5-out/predictions_ssp585_full_2025-2099.csv"))
# Evaluation (model predictions for 2014–2024 as log_baseflow)
eval_245 <- read_csv(here("1-data/WUS-D3_climate_data/eval_data_ssp245.csv"))
eval_585 <- read_csv(here("1-data/WUS-D3_climate_data/eval_data_ssp585.csv"))
# Training (for baseline)
training_data <- read_csv(here("1-data/training_data.csv")) %>%
mutate(log_baseflow = log(pmax(baseflow, 0.001)))
# ---------- Helpers ----------
tag_period <- function(y) dplyr::case_when(
y >= 2025 & y <= 2049 ~ "Early (2025–2049)",
y >= 2050 & y <= 2074 ~ "Mid (2050–2074)",
y >= 2075 & y <= 2099 ~ "Late (2075–2099)",
TRUE ~ NA_character_
)
# Smearing factors (by cluster)
smear_tbl <- tibble::tibble(
cluster = factor(c(1, 2, 3, 4)),
smear   = c(1.03, 1.03, 0.957, 0.764)
)
ensure_linear_preds <- function(df, smear_tbl) {
if (!"baseflow_hat" %in% names(df)) {
df <- df %>%
mutate(cluster = factor(cluster),
month   = as.integer(month)) %>%
left_join(smear_tbl, by = "cluster") %>%
mutate(
smear        = coalesce(smear, 1.0),
yhat_log     = if ("yhat_log" %in% names(.)) yhat_log else log_baseflow,
baseflow_hat = exp(yhat_log) * smear
) %>%
select(-smear)
}
df
}
# cfs -> AF for a given month
cf_to_af <- function(cfs, y, m) {
d <- lubridate::days_in_month(lubridate::ymd(paste(y, m, 15)))
(cfs * 86400 * d) / 43560
}
# ---------- Baseline (historical, observed) ----------
# Monthly baseline in cfs; convert to AF when needed with cf_to_af()
baseline <- training_data %>%
filter(year >= 1980, year <= 2013) %>%
group_by(cluster, month) %>%
summarise(baseline_bf = mean(baseflow, na.rm = TRUE), .groups = "drop") %>%
mutate(cluster = as.factor(cluster), month = as.integer(month))
# ---------- Prepare projections ----------
preds_245 <- preds_245 %>% mutate(cluster = as.factor(cluster), month = as.integer(month))
preds_585 <- preds_585 %>% mutate(cluster = as.factor(cluster), month = as.integer(month))
preds_245_full <- ensure_linear_preds(preds_245, smear_tbl) %>% mutate(scenario = "SSP245")
preds_585_full <- ensure_linear_preds(preds_585, smear_tbl) %>% mutate(scenario = "SSP585")
preds_all_full <- bind_rows(preds_245_full, preds_585_full) %>%
left_join(baseline, by = c("cluster","month"))
# ---------- Build monthly AF + %AF anomalies ----------
preds_vol <- preds_all_full %>%
mutate(
pred_AF      = cf_to_af(baseflow_hat, year, month),
baseline_AF  = cf_to_af(baseline_bf,  year, month),
anomaly_AF   = pred_AF - baseline_AF,
anomaly_AFpc = 100 * anomaly_AF / baseline_AF
)
# Colors
clrs <- c(`1`="#7db030", `2`="#ff3432", `3`="#FFB81F", `4`="#2487EE")
mon_agg <- preds_vol %>%
mutate(period = tag_period(year)) %>%
filter(!is.na(period)) %>%
group_by(cluster, scenario, period, month) %>%
summarise(
pct_mon_med = median(anomaly_AFpc, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
cluster = factor(cluster, levels = c("1","2","3","4")),
period  = factor(period, levels = c("Early (2025–2049)",
"Mid (2050–2074)",
"Late (2075–2099)"))
)
readr::write_csv(mon_agg, here("5-out/anomalies_percent_monthly_by_period_AF.csv"))
p_season_pct <- ggplot(mon_agg, aes(x = month, y = pct_mon_med, color = cluster, group = cluster)) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey55") +
geom_line(linewidth = 0.9) +
geom_point(size = 1.1) +
facet_grid(period ~ scenario) +
scale_x_continuous(breaks = 1:12) +
scale_color_manual(values = clrs, name = "Cluster") +
labs(x = "Month", y = "Percent difference from 1980–2013 (%)",
title = "Seasonal percent **volume** anomalies by period and scenario (cluster medians)") +
theme_minimal(base_size = 12) +
theme(panel.grid.minor = element_blank(),
panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
strip.background = element_rect(fill = "grey90", color = "black"),
legend.position = "top")
p_season_pct
ggsave(here("5-out/figures/seasonal_anomaly_percent_AF.svg"), p_season_pct, width = 11, height = 7.5, dpi = 600)
ggsave(here("5-out/figures/seasonal_anomaly_percent_AF.png"), p_season_pct, width = 11, height = 7.5, dpi = 600)
p_annual_vol_abs
install.packages(c("rmarkdown", "quarto"))
